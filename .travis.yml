sudo: required
dist: trusty
language: node_js
node_js: 8.6.0
addons:
  firefox: "52.3.0"
cache:
  yarn: true
  directories:
    - api
before_install:
  - "export DISPLAY=:99.0"
  - "sh -e /etc/init.d/xvfb start"
    # Fire up database
  - "sudo mkdir -p /data/db"
  - "sudo chown -R `id -u` /data/db"
  - "sudo chmod -R go+w /data/db"
  - "mongod &"
  - "sleep 5"
  # Clone backend repo
  - "[ -d api/.git ] || git clone git@github.com:Equibit/wallet-api.git api"
  - "cd api"
  # Run server
  - "TESTING=true NODE_ENV=testing npm start &"
  # Wait for server to start
  - "sleep 5"
  - "cd .."
before_script:
  - mongo wallet_api-testing --eval 'db.users.insertOne({"_id":"5b4cd9326402461d2d80643c","pastPasswordHashes":["15c19e178b72635245d0deac1b9f09d495ea5b72bc0069fd5c773f0cc3bbd746","91ce0064ece5029452c4145edaa737ef579c799a7cc7e2c62a7fc17265824eb3"],"isNewUser":false,"hasRecordedMnemonic":true,"twoFactorValidatedSession":false,"emailVerified":true,"autoLogoutTime":1800000,"email":"elliott@evenset.com","tempPassword":null,"tempPasswordCreatedAt":null,"salt":"5575d8467b421eb1524c","failedLogins":[{"_id":"5b4e2c2c4e5f0f223ffb88da","date":"2018-07-17T17:49:32.919Z","sendEmail":false},{"_id":"5b4e2c314e5f0f223ffb88dd","date":"2018-07-17T17:49:37.344Z","sendEmail":false}],"createdAt":"2018-07-16T17:43:14.250Z","updatedAt":"2018-07-25T13:41:02.657Z","challenge":null,"provisionalSalt":null,"password":"b682193c4f1d4f57cf34ea2ab108152b936938d9651cd4257ec5deb543a84d3c28b7f60f9967b87324a4cb06aab265340a1f6faca145b998ab1dc1355ce238511cc4e7d494a30c362d8efbfe44b3a3cd418014c104eb5079ec0c77d23f4bf6c70dd19b6da4e0c36a7886b04a6b0d61d252f603293682294dbd18cec321281d01334893ee3ee66068e48fa5af296ded3da9d310d8d927367e64ba98916fcbb1e34d93f5bf15cf1caf318e8cb4f8fed97c279a5adc5b931ef00d0cbfe7592257944f29cebde35583eb7c3eba1a27add9a04e8386d44c54be9126e2d0549f5824f65da20de839de62000b5adf5809b5553a75fb20652a1d2798750d3385d17f11fda2c84ac1c608ef877bc48133fe0d816bab699344404c57daf419c9c75f57634673041b4c65cf84c1dff5e20f20ab7194eec90910e30d7c89ec3ac5398e721b5c5f5d9a6ef6f06e8b25d67e1399f433d0c6157a4c8810fa22333fdedb6582f07ba33ac412ee59b428ae5d7af3b6be981607be2da9fef671a9d64f00472a30085763c28b6cb977f13e73f82d428dad811c23301c91ce0ff0e57e292eff4fdff077a0bdb87962095daadccce8b71ffbc8342fde6f6b88851b70ce019ac80bf3d4a55800b7011e4695c1e130b4074c6b8b25e397ad6a2d12e0edfd49db8ec313c27c33a159df30a2738de3186a81e8e373ab45831834cba0656076f1c57e5e6a7750","passwordCreatedAt":"2018-07-17T21:49:41.604Z","encryptedKey":"6278dcb62fb366cca3e7977f6eb7cfbde1b9b429421f2a00a3304deda19ab04ca04d9fe59f0a900bdffbf1eb1b2b5b3983ab0618ec2d71ee940820a737766ca21ebc029b77917456deeabdd565b9583040df6b59216ca359d58c00729e74f97f698819e21feeab088bd3a845dd392c15","encryptedMnemonic":"462cc6e90dc3d9ad1da21119b5612703708f4d653aefe8149f8401505ba4c0c6e6a15f7ed49c345de003247631a42084f39cb38f7cdc8ca37fc5d0342c2d32ae54c5584b5083dfba699b698c65490d40","twoFactorCode":null})'
script:
  - sudo sh -c "dbus-uuidgen > /etc/machine-id"
  - npm run test
  - npm run test-cypress
after_script:
  - kill $(jobs -p) || true
  - mongod --shutdown
  - pkill node